"use strict";

// console.log("js start");

/* ========================================================================
 * User settings
 * ======================================================================== */
var userSet = {
  load: {
    img: true
  },
  breakpoint: 768,
  anchorLink: {
    duration: .5
  },
  wrap: {
    wrapperClass: "wrapper"
  },
  globalNav: {
    "class": "gnav",
    menuBtn: "header__menubtn",
    openState: "data-open"
  },
  pageTop: {
    "class": "pagetop",
    currentState: "data-current",
    duration: .8
  },
  slide: {
    singleClass: "js-sliSL",
    // gsapによるtranslateのスライド処理を追加(-left,-right,-top,-bottomで方向を指定)
    multiClass: "js-stgSL",
    // gsapのstaggerによるchildrenのtranslateのスライド処理を追加(-left,-right,-top,-bottomで方向を指定)
    data: {
      sliDuration: "data-sliDur",
      // gsapのduration (default:.3)
      sliValue: "data-sliVal",
      // gsapのtranslateの量 (default:20)
      sliDelay: "data-sliDelay",
      // 遅延時間を指定 (default:.7)
      sliFrom: "data-sliFrom" // multiのみ 開始する箇所を指定 (default:start, 他指定値:{start, center, edges, random, end)

    }
  }
};
/* ========================================================================
 * init
 * ======================================================================== */

var $html = document.getElementsByTagName("html");
var $body = document.getElementsByTagName("body");
/* --- Common letiable --- */

var $wrapper = document.querySelector("." + userSet.wrap.wrapperClass);
var ww = window.innerWidth;
var wh = window.innerHeight;
var w_breakPoint = userSet.breakpoint;

var _sTop = document.documentElement.scrollTop || document.body.scrollTop;

var mousewheelevent = 'onwheel' in document ? 'wheel' : 'onmousewheel' in document ? 'mousewheel' : 'DOMMouseScroll';
/* --- 画像preload --- */

var is_ready = false;
var $allImage = document.querySelectorAll(".main img");
var allImageCount = $allImage.length;
var completeImageCount = 0;
var cssImgResults = [];
var cssSheets = document.styleSheets;
var completecssImageCount = 0;
/* --- スライドフェードイン --- */

var $sliSL = document.querySelectorAll("." + userSet.slide.sigleClass);
var sliSLArr = [];
var sliSLFlagArr = [];
var sliSLTopArr = [];

for (var sliSLCount = 0; sliSLCount < $sliSL.length; sliSLCount++) {
  $sliSL[sliSLCount].style.opacity = 0;
}

var $stgSL = document.querySelectorAll("." + userSet.slide.multiClass);
var stgSLArr = [];
var stgSLFlagArr = [];
var stgSLTopArr = [];

for (var stgSLCount = 0; stgSLCount < $stgSL.length; stgSLCount++) {
  var $stgSLChild = $stgSL[stgSLCount].children;

  for (var stgSLChildCount = 0; stgSLChildCount < $stgSLChild.length; stgSLChildCount++) {
    $stgSLChild[stgSLChildCount].style.opacity = 0;
  }
}
/* --- SPメニュー --- */


var $gnav = document.querySelector("." + userSet.globalNav["class"]);
var $menuBtn = document.querySelector("." + userSet.globalNav.menuBtn);
var menuBtnTop;
var is_gnav = false;
var is_open = false;
/*--
console.log($ancLink);アンカーリンク処理 --- */

var $ancLink = document.querySelectorAll("a[href^='#']");
var ancTopArr = [];
/* --- pageTop --- */

var $pageTop = document.querySelector("." + userSet.pageTop["class"]);
var is_pageTop = false;
var _SP = false;

if (ww > w_breakPoint) {
  _SP = false;
} else {
  _SP = true;
}

window.addEventListener("resize", function (e) {
  ww = window.innerWidth;
  wh = window.innerHeight;

  if (ww > w_breakPoint) {
    _SP = false;
  } else {
    _SP = true;
  }
});
/* -----------------------------------------------
 * Ready imageなど遅延ロード
 * ----------------------------------------------- */

document.addEventListener("DOMContentLoaded", function () {
  // console.log("ready");
  if (userSet.load.img) {
    try {
      if (Array.from) {
        (function () {
          var classesEle = Array.from(document.querySelectorAll('[class]')); // 全要素からクラス名を持つ要素を取得

          var classes = [];

          for (var i = 0; i < classesEle.length; i++) {
            classes.push(Array.from(classesEle[i].classList));
          }

          var flatten = Array.prototype.concat.apply([], classes);
          var set = new Set(flatten);
          var arrSet = Array.from(set); // 開いているHTMLから全クラス名を取得

          var cssStyle = [];

          for (var _i = 0; _i < arrSet.length; _i++) {
            var block = document.getElementsByClassName(arrSet[_i]);

            if (window.getComputedStyle(block[0]).getPropertyValue("background-image") !== "none") {
              if (window.getComputedStyle(block[0]).getPropertyValue("background-image").includes("url")) {
                cssStyle.push(window.getComputedStyle(block[0]).getPropertyValue("background-image"));
              }
            } else if (window.getComputedStyle(block[0], "::after").getPropertyValue("background-image") !== "none") {
              if (window.getComputedStyle(block[0], "::after").getPropertyValue("background-image").includes("url")) {
                cssStyle.push(window.getComputedStyle(block[0], "::after").getPropertyValue("background-image"));
              }
            } else if (window.getComputedStyle(block[0], "::before").getPropertyValue("background-image") !== "none") {
              if (window.getComputedStyle(block[0], "::before").getPropertyValue("background-image").includes("url")) {
                cssStyle.push(window.getComputedStyle(block[0], "::before").getPropertyValue("background-image"));
              }
            }
          }

          if (cssStyle.length === 0) {
            is_ready = true;
            readySection();
          } else {
            for (var j = 0; j < cssStyle.length; j++) {
              // let img = new Image();
              var $imgnew = document.createElement("img"); // let imgurl = cssStyle[j].slice(5).slice(0, -2);

              var imgurl = cssStyle[j].replace(/"/g, '');
              imgurl = imgurl.slice(4).slice(0, -1);
              $imgnew.setAttribute("src", imgurl);
              $imgnew.addEventListener("load", function (response, status, xhr) {
                completecssImageCount++;

                if (completecssImageCount == cssStyle.length) {
                  is_ready = true;
                  readySection();
                }
              });
            }
          }
        })();
      } else {
        is_ready = true;
        readySection();
      }
    } catch (e) {
      // console.log("try");
      is_ready = true;
      readySection();
    }
  } else {
    readyInit();
  }
});
/* -- imgタグ参照 -- */

var readySection = function readySection() {
  // console.log("section start");
  if (is_ready) {
    if (allImageCount < 1) {
      readyInit();
    } else {
      for (var i = 0; i < allImageCount; i++) {
        var image = new Image();
        var $src = $allImage[i].getAttribute('src');
        image.src = $src;
        var $new = document.createElement("img");
        $allImage[i].style.opacity = 0;

        if (!$src || image.width == 0) {
          completeImageCount++;
        } else {
          $new.addEventListener("load", function () {
            completeImageCount++;

            if (allImageCount == completeImageCount) {
              for (var j = 0; j < $allImage.length; j++) {
                $allImage[j].removeAttribute('style');
              }

              setTimeout(function () {
                readyInit();
              }, 100);
            }
          });
        }

        $new.setAttribute("src", $allImage[i].getAttribute('src'));
      }
    }
  }
};
/* -- Ready init (Loadが終わったら) -- */


var readyInit = function readyInit() {
  var _loop = function _loop(ancCount) {
    if (!$ancLink[ancCount].hasAttribute("noscroll")) {
      var ancObj = document.getElementById($ancLink[ancCount].getAttribute("href").slice(1));
      ancTopArr[ancCount] = _sTop + ancObj.getBoundingClientRect().top;
      $ancLink[ancCount].addEventListener("click", function (e) {
        e.preventDefault();
        var href = this.getAttribute("href");
        scrollAnc(href, userSet.anchorLink.duration, ancTopArr[ancCount]);
      });
    }
  };

  // console.log("init start");
  // アンカーリンク
  for (var ancCount = 0; ancCount < $ancLink.length; ancCount++) {
    _loop(ancCount);
  }
  /* sliSL */


  var wscroll = _sTop + wh;

  for (var i = 0; i < sliSLTopArr.length; i++) {
    if (sliSLTopArr[i] <= wscroll) {
      sliSLFlagArr[i] = true;
      sliSLAnime(sliSLArr[i]);
    }
  }

  for (var _i2 = 0; _i2 < stgSLTopArr.length; _i2++) {
    if (stgSLTopArr[_i2] <= wscroll) {
      stgSLFlagArr[_i2] = true;
      stgSLInAnime(stgSLArr[_i2]);
    }
  }
};
/* -----------------------------------------------
 * sliSL stgSL
 * ----------------------------------------------- */

/* 単発slide */


for (var _sliSLCount = 0; _sliSLCount < $sliSL.length; _sliSLCount++) {
  var $this = $sliSL[_sliSLCount];
  sliSLArr[_sliSLCount] = $this;
  sliSLFlagArr[_sliSLCount] = false;
  sliSLTopArr[_sliSLCount] = $this.getBoundingClientRect().top;
}

var sliSLAnime = function sliSLAnime($obj) {
  gsap.killTweensOf($obj);
  var SLIdur = .3;
  var SLIval = 20;
  var SLIdelay = .7;
  if ($obj.getAttribute(userSet.slide.data.sliDuration) >= 0) SLIdur = Number($obj.getAttribute(userSet.slide.data.sliDuration));
  if ($obj.getAttribute(userSet.slide.data.sliValue) >= 0) SLIval = $obj.getAttribute(userSet.slide.data.sliValue);
  if ($obj.getAttribute(userSet.slide.data.sliDelay) >= 0) SLIdelay = $obj.getAttribute(userSet.slide.data.sliDelay);

  if ($obj.classList.contains(userSet.slide.singleClass + "-left")) {
    gsap.fromTo($obj, {
      duration: SLIdur,
      x: -1 * SLIval,
      opacity: 0
    }, {
      x: 0,
      opacity: 1,
      delay: SLIdelay,
      onComplete: function onComplete() {
        $obj.removeAttribute("style");
        $obj.classList.remove(userSet.slide.singleClass, userSet.slide.singleClass + "-left");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.singleClass + "-right")) {
    gsap.fromTo($obj, {
      duration: SLIdur,
      x: SLIval,
      opacity: 0
    }, {
      x: 0,
      opacity: 1,
      delay: SLIdelay,
      onComplete: function onComplete() {
        $obj.removeAttribute("style");
        $obj.classList.remove(userSet.slide.singleClass, userSet.slide.singleClass + "-right");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.singleClass + "-top")) {
    gsap.fromTo($obj, {
      duration: SLIdur,
      y: -1 * SLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: SLIdelay,
      onComplete: function onComplete() {
        $obj.removeAttribute("style");
        $obj.classList.remove(userSet.slide.singleClass, userSet.slide.singleClass + "-top");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.singleClass + "-bottom")) {
    gsap.fromTo($obj, {
      duration: SLIdur,
      y: SLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: SLIdelay,
      onComplete: function onComplete() {
        $obj.removeAttribute("style");
        $obj.classList.remove(userSet.slide.singleClass, userSet.slide.singleClass + "-bottom");
      }
    });
  } else {
    gsap.fromTo($obj, {
      duration: SLIdur,
      y: SLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: SLIdelay,
      onComplete: function onComplete() {
        $obj.removeAttribute("style");
        $obj.classList.remove(userSet.slide.singleClass);
      }
    });
  }
};
/* 連続したslide */


for (var _stgSLCount = 0; _stgSLCount < $stgSL.length; _stgSLCount++) {
  var _$this = $stgSL[_stgSLCount];
  stgSLArr[_stgSLCount] = _$this;
  stgSLFlagArr[_stgSLCount] = false;
  stgSLTopArr[_stgSLCount] = _$this.getBoundingClientRect().top;
}

var stgSLInAnime = function stgSLInAnime($obj) {
  var stgSLIdur = .3;
  var stgSLIval = 20;
  var stgSLIdelay = .7;
  var stgSLIfrom = "start";
  if ($obj.getAttribute(userSet.slide.data.sliDuration) >= 0) stgSLIdur = Number($obj.getAttribute(userSet.slide.data.sliDuration));
  if ($obj.getAttribute(userSet.slide.data.sliValue) >= 0) stgSLIval = Number($obj.getAttribute(userSet.slide.data.sliValue));
  if ($obj.getAttribute(userSet.slide.data.sliDelay) >= 0) stgSLIdelay = Number($obj.getAttribute(userSet.slide.data.sliDelay));
  if ($obj.getAttribute(userSet.slide.data.sliFrom)) stgSLIfrom = $obj.getAttribute(userSet.slide.data.sliFrom);

  if ($obj.classList.contains(userSet.slide.multiClass + "-left")) {
    gsap.fromTo($obj.children, {
      duration: stgSLInAnime,
      x: -1 * stgSLIval,
      opacity: 0
    }, {
      x: 0,
      opacity: 1,
      delay: stgSLIdelay,
      stagger: {
        amount: .15,
        from: stgSLIfrom
      },
      onComplete: function onComplete() {
        for (var i = 0; i < $obj.children.length; i++) {
          $obj.children[i].removeAttribute("style");
        }

        $obj.classList.remove(userSet.slide.multiClass, userSet.slide.multiClass + "-left");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.multiClass + "-right")) {
    gsap.fromTo($obj.children, {
      duration: stgSLInAnime,
      x: stgSLIval,
      opacity: 0
    }, {
      x: 0,
      opacity: 1,
      delay: stgSLIdelay,
      stagger: {
        amount: .15,
        from: stgSLIfrom
      },
      onComplete: function onComplete() {
        for (var i = 0; i < $obj.children.length; i++) {
          $obj.children[i].removeAttribute("style");
        }

        $obj.classList.remove(userSet.slide.multiClass, userSet.slide.multiClass + "-right");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.multiClass + "-top")) {
    gsap.fromTo($obj.children, {
      duration: stgSLInAnime,
      y: -1 * stgSLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: stgSLIdelay,
      stagger: {
        amount: .15,
        from: stgSLIfrom
      },
      onComplete: function onComplete() {
        for (var i = 0; i < $obj.children.length; i++) {
          $obj.children[i].removeAttribute("style");
        }

        $obj.classList.remove(userSet.slide.multiClass, userSet.slide.multiClass + "-top");
      }
    });
  } else if ($obj.classList.contains(userSet.slide.multiClass + "-bottom")) {
    gsap.fromTo($obj.children, {
      duration: stgSLInAnime,
      y: stgSLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: stgSLIdelay,
      stagger: {
        amount: .15,
        from: stgSLIfrom
      },
      onComplete: function onComplete() {
        for (var i = 0; i < $obj.children.length; i++) {
          $obj.children[i].removeAttribute("style");
        }

        $obj.classList.remove(userSet.slide.multiClass, userSet.slide.multiClass + "-bottom");
      }
    });
  } else {
    gsap.fromTo($obj.children, {
      duration: stgSLInAnime,
      y: stgSLIval,
      opacity: 0
    }, {
      y: 0,
      opacity: 1,
      delay: stgSLIdelay,
      stagger: {
        amount: .15,
        from: stgSLIfrom
      },
      onComplete: function onComplete() {
        for (var i = 0; i < $obj.children.length; i++) {
          $obj.children[i].removeAttribute("style");
        }

        $obj.classList.remove(userSet.slide.multiClass);
      }
    });
  }
};
/* ========================================================================
 * Event
 * ======================================================================== */

/* -----------------------------------------------
 * アンカークリック
 * ----------------------------------------------- */


var scrollAnc = function scrollAnc($object, $speed, $scroll) {
  var hash = $object;
  var $target;
  var t_hash; // let h_h = document.querySelector(".header").clientHeight; // scrollToの位置の差異を作る
  // if(is_open) $menuBtn.dispatchEvent(new Event("click")); SPでgnavをopenしている時アンカーリンクをクリックしたら

  if (hash === "#") {
    t_hash = 0;
  } else {
    t_hash = $scroll;
  }

  gsap.to(window, {
    duration: $speed,
    scrollTo: t_hash
  });
};
/* -----------------------------------------------
 * ページトップ スクロール
 * ----------------------------------------------- */


$pageTop.addEventListener('click', function (e) {
  e.preventDefault();

  if (!is_pageTop) {
    is_pageTop = true;
    gsap.to(window, {
      duration: userSet.pageTop.duration,
      scrollTo: 0,
      onComplete: function onComplete() {
        is_pageTop = false;
      }
    });
  }
});
/* -----------------------------------------------
 * SP メニュー
 * ----------------------------------------------- */

$menuBtn.addEventListener('click', function (e) {
  var h_gnav = Number(window.innerHeight);

  if (!is_gnav) {
    if (!is_open) {
      menuBtnTop = document.documentElement.scrollTop || document.body.scrollTop;
      is_open = true;
      is_gnav = true;
      $menuBtn.setAttribute(userSet.globalNav.openState, true);
      $wrapper.style.position = "fixed";
      $wrapper.style.top = "-" + menuBtnTop + "px";
      $wrapper.style.left = 0;
      gsap.to($gnav, {
        duration: .3,
        height: h_gnav,
        onComplete: function onComplete() {
          is_gnav = false;
        }
      });
    } else {
      $wrapper.removeAttribute('style');
      window.scrollTo({
        top: menuBtnTop
      });
      is_open = false;
      is_gnav = true;
      $menuBtn.setAttribute(userSet.globalNav.openState, false);
      gsap.to($gnav, {
        duration: .3,
        height: 0,
        onComplete: function onComplete() {
          is_gnav = false;
        }
      });
    }
  }
});
/* -----------------------------------------------
 * - スクロール -
 * ----------------------------------------------- */

window.addEventListener('scroll', function (e) {
  e.preventDefault();
  _sTop = document.body.scrollTop || document.documentElement.scrollTop;
  wh = window.innerHeight;

  var _sMdl = _sTop + wh / 2;

  var _sBtm = _sTop + wh;

  var diffVal = 100;
  /* sliSL */

  for (var i = 0; i < sliSLArr.length; i++) {
    if (!sliSLFlagArr[i] && sliSLTopArr[i] <= _sBtm - diffVal) {
      sliSLFlagArr[i] = true;
      sliSLAnime(sliSLArr[i]);
    }
  }
  /* stgSL */


  for (var _i3 = 0; _i3 < stgSLArr.length; _i3++) {
    if (!stgSLFlagArr[_i3] && stgSLTopArr[_i3] <= _sBtm - diffVal) {
      stgSLFlagArr[_i3] = true;
      stgSLInAnime(stgSLArr[_i3]);
    }
  } // headerFixed(_sTop);


  if (_sTop > wh) {
    $pageTop.setAttribute(userSet.pageTop.currentState, true);
  } else {
    $pageTop.setAttribute(userSet.pageTop.currentState, false);
  }
});